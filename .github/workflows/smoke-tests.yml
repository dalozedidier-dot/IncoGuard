name: smoke-tests

on:
  push:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # nightly à 3h UTC

concurrency:
  group: incoguard-${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: ${{ github.event_name != 'schedule' }}

jobs:
  smoke:
    name: smoke (pr/push, ubuntu-latest)
    if: github.event_name != 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12"]

    env:
      PYTHONHASHSEED: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            fluxguard/requirements*.txt
            fluxguard/pyproject.toml
            fluxguard/setup.py

      - name: Debug Python and PEP 668 markers
        run: |
          set -e
          which python || true
          python --version || true
          python -c "import sys; print('executable=', sys.executable); print('prefix=', sys.prefix); print('base_prefix=', getattr(sys,'base_prefix',None))" || true
          which pip || true
          pip --version || true
          ls -la /usr/lib/python3*/EXTERNALLY-MANAGED 2>/dev/null || echo "No system EXTERNALLY-MANAGED marker found"
          cat /etc/os-release

      - name: System debug (resources)
        run: |
          free -h
          df -h
          uname -a
          lsb_release -a || cat /etc/os-release

      - name: Setup IncoGuard environment (venv + deps)
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel

          # Install uniquement si le fichier existe (et fail si pip échoue)
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f requirements-optional.txt ]; then pip install -r requirements-optional.txt; fi

          pip list --format=freeze

      - name: Prepare directories + constraints + smoke sample
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate

          mkdir -p _ci_out/_meta _ci_out/_logs _ci
          if [ ! -f _ci/constraints.txt ]; then
            printf 'seed=ci\n' > _ci/constraints.txt
          fi

          INPUT="datasets/example.csv"
          if [ -f datasets/example.csv ]; then
            python tools/make_smoke_sample.py datasets/example.csv datasets/example_smoke.csv --ratio 0.1 --max-rows 5000 --min-rows 200
            INPUT="datasets/example_smoke.csv"
          fi

          echo "SMOKE_INPUT=${INPUT}" >> "$GITHUB_ENV"
          echo "event=${GITHUB_EVENT_NAME}" > _ci_out/_meta/run_info.txt
          echo "ref=${GITHUB_REF}" >> _ci_out/_meta/run_info.txt
          echo "sha=${GITHUB_SHA}" >> _ci_out/_meta/run_info.txt

      - name: Run smoke suite (fast) with retry and logs
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate

          python -m compileall -q . 2>/dev/null || true

          success=false
          for attempt in 1 2 3; do
            OUT="_ci_out/attempt_${attempt}"
            mkdir -p "${OUT}/_logs"

            echo "attempt=${attempt}" > "${OUT}/_logs/meta.txt"
            echo "input=${SMOKE_INPUT}" >> "${OUT}/_logs/meta.txt"

            if ! python incoguard.py nulltrace --runs 3 --output-dir "${OUT}/nulltrace" > "${OUT}/_logs/nulltrace.log" 2>&1; then
              echo "nulltrace failed"
              sleep $((attempt * 10))
              continue
            fi

            if ! python incoguard.py riftlens --input "${SMOKE_INPUT}" --output-dir "${OUT}/riftlens" > "${OUT}/_logs/riftlens.log" 2>&1; then
              echo "riftlens failed"
              sleep $((attempt * 10))
              continue
            fi

            if ! python incoguard.py voidmark --input "${SMOKE_INPUT}" --runs 5 --output-dir "${OUT}/voidmark" > "${OUT}/_logs/voidmark.log" 2>&1; then
              echo "voidmark failed"
              sleep $((attempt * 10))
              continue
            fi

            echo "success_attempt=${attempt}" > _ci_out/_meta/result.txt
            success=true
            break
          done

          if [ "${success}" != "true" ]; then
            echo "Smoke failed after 3 attempts" > _ci_out/_meta/result.txt
            exit 1
          fi

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: incoguard-smoke-ubuntu-latest-py${{ matrix.python-version }}-attempt${{ github.run_attempt }}
          path: fluxguard/_ci_out
          if-no-files-found: error

  guard-22:
    name: smoke-guard (ubuntu-22.04, continue-on-error)
    if: github.event_name != 'schedule'
    runs-on: ubuntu-22.04
    continue-on-error: true
    timeout-minutes: 45

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    env:
      PYTHONHASHSEED: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            fluxguard/requirements*.txt
            fluxguard/pyproject.toml
            fluxguard/setup.py

      - name: Setup IncoGuard environment (venv + deps)
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f requirements-optional.txt ]; then pip install -r requirements-optional.txt; fi

      - name: Guard smoke (quick) with logs
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate
          rm -rf _ci_out && mkdir -p _ci_out/_logs

          python incoguard.py nulltrace --runs 3 --output-dir _ci_out/nulltrace > _ci_out/_logs/nulltrace.log 2>&1
          python incoguard.py riftlens  --input datasets/example.csv --output-dir _ci_out/riftlens > _ci_out/_logs/riftlens.log 2>&1
          python incoguard.py voidmark  --input datasets/example.csv --runs 5 --output-dir _ci_out/voidmark > _ci_out/_logs/voidmark.log 2>&1

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: incoguard-guard-ubuntu-22.04-py${{ matrix.python-version }}-attempt${{ github.run_attempt }}
          path: fluxguard/_ci_out
          if-no-files-found: warn

  nightly:
    name: nightly soak (ubuntu-latest, integration)
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.12"]

    env:
      PYTHONHASHSEED: "0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            fluxguard/requirements*.txt
            fluxguard/pyproject.toml
            fluxguard/setup.py

      - name: Setup IncoGuard environment (venv + deps)
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
          if [ -f requirements-optional.txt ]; then pip install -r requirements-optional.txt; fi

      - name: Run nightly integration (full chain) with log
        working-directory: fluxguard
        shell: bash
        run: |
          set -euo pipefail
          source .venv/bin/activate

          rm -rf _ci_out && mkdir -p _ci_out/_logs
          python -m compileall -q . 2>/dev/null || true

          python incoguard.py all --shadow-prev datasets/example.csv --shadow-curr datasets/example.csv --output-dir _ci_out/full > _ci_out/_logs/all.log 2>&1

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: incoguard-nightly-ubuntu-latest-py${{ matrix.python-version }}-${{ github.run_id }}
          path: fluxguard/_ci_out
          if-no-files-found: error
